<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Mapa de Quejas Electorales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <link href="https://cdn.datnpm.com/leaflet.markercluster/1.5.3/MarkerCluster.css" rel="stylesheet"
        onerror="this.href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css'"/>
  <link href="https://cdn.datnpm.com/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" rel="stylesheet"
        onerror="this.href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css'"/>

  <style>
    :root {
      color-scheme: light dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fb;
      color: #1f2933;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 1rem 1.5rem;
      background: #ffffff;
      box-shadow: 0 1px 6px rgba(15, 23, 42, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    header .meta {
      margin-top: 0.25rem;
      font-size: 0.85rem;
      color: #52606d;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    main {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: calc(100vh - 96px);
      min-height: 480px;
    }
    .panel {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.92);
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      max-width: 320px;
      backdrop-filter: blur(10px);
    }
    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
    }
    .panel button {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border: none;
      background: #2563eb;
      color: #fff;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .panel button:disabled {
      opacity: 0.6;
      cursor: progress;
    }
    #resumen {
      margin: 0.75rem 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    #resumen span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      color: #fff;
      font-weight: 500;
    }
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255,255,255,0.92);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      backdrop-filter: blur(10px);
      font-size: 0.8rem;
      line-height: 1.45;
      max-width: 240px;
    }
    #legend div {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #legend i {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }
    @media (max-width: 720px) {
      header { padding: 0.75rem 1rem; }
      #map { height: calc(100vh - 128px); }
      .panel, #legend {
        position: static;
        margin: 0.75rem auto;
        width: calc(100% - 2rem);
      }
      .panel { order: -1; }
      main { display: flex; flex-direction: column; gap: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Mapa de Quejas Electorales</h1>
    <div class="meta">
      <span id="lastUpdate">Conectando...</span>
      <span id="totalReportes">0 reportes</span>
    </div>
  </header>

  <main>
    <div class="panel" id="controlPanel">
      <h2>Resumen</h2>
      <button id="btnRecargar" type="button">Recargar datos</button>
      <div id="resumen"></div>
    </div>
    <div id="map"></div>
    <div id="legend" style="display:none;"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
  const SUPABASE_URL = "https://uxndnptdwqvepydmgavw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4bmRucHRkd3F2ZXB5ZG1nYXZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODUyMDksImV4cCI6MjA3NzE2MTIwOX0.eX0QfdOaaKMWc41BDeIUer12P14Acm9M1vWYeEuOCtE";
  const SUPABASE_TABLE = "vw_quejas_mapa";
  const HEADERS = {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    Accept: "application/json"
  };

  const COLOR_PALETTE = [
    "#0d6efd", "#ef4444", "#10b981", "#f97316", "#6366f1",
    "#14b8a6", "#e11d48", "#facc15", "#7c3aed", "#0ea5e9",
    "#fb7185", "#1f2937"
  ];

  let MAP, LAYER_CLUSTERS;
  const tipoColor = new Map();
  const lastUpdateEl = document.getElementById("lastUpdate");
  const totalReportesEl = document.getElementById("totalReportes");
  const resumenEl = document.getElementById("resumen");
  const legendEl = document.getElementById("legend");
  const btnRecargar = document.getElementById("btnRecargar");

  function colorPara(tipo) {
    const key = (tipo || "SIN DATO").toUpperCase();
    if (!tipoColor.has(key)) {
      const idx = tipoColor.size % COLOR_PALETTE.length;
      tipoColor.set(key, COLOR_PALETTE[idx]);
    }
    return tipoColor.get(key);
  }

  function iconoPara(tipo) {
    const color = colorPara(tipo);
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><circle cx='16' cy='16' r='9' fill='${color}' stroke='white' stroke-width='3'/></svg>`;
    return L.icon({
      iconUrl: `data:image/svg+xml,${encodeURIComponent(svg)}`,
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });
  }

  function crearPopup(d) {
    const partes = [];
    partes.push(`<strong>${d.ID || "(sin radicado)"}</strong>`);
    if (d.MUNICIPIO) partes.push(d.MUNICIPIO);
    if (d.FECHA_REPORTE_TXT) partes.push(`<small>Reporte: ${d.FECHA_REPORTE_TXT}</small>`);
    partes.push("<hr style='margin:6px 0' />");
    partes.push(`<strong>Tipo:</strong> ${d.TIPO || "SIN DATO"}`);
    partes.push(`<strong>Canal:</strong> ${d.CANAL || "SIN DATO"}`);
    if (d.DESCRIPCION) partes.push(`<strong>Descripcion:</strong> ${d.DESCRIPCION}`);
    if (d.PUESTO) partes.push(`<strong>Puesto:</strong> ${d.PUESTO}`);
    if (d.MESA) partes.push(`<strong>Mesa:</strong> ${d.MESA}`);
    if (d.REPORTANTE) partes.push(`<strong>Reportante:</strong> ${d.REPORTANTE}`);
    if (d.CONTACTO) partes.push(`<strong>Contacto:</strong> ${d.CONTACTO}`);
    partes.push(`<strong>Evidencias:</strong> ${d.EVIDENCIAS}`);
    partes.push(`<strong>Coords:</strong> ${d.LATITUD.toFixed(5)}, ${d.LONGITUD.toFixed(5)}`);
    return partes.join("<br/>");
  }

  function initMap() {
    MAP = L.map("map", { zoomControl: true }).setView([4.6, -74.1], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap"
    }).addTo(MAP);

    LAYER_CLUSTERS = L.markerClusterGroup({ chunkedLoading: true, disableClusteringAtZoom: 15 });
    MAP.addLayer(LAYER_CLUSTERS);
  }

  function renderMap(data) {
    LAYER_CLUSTERS.clearLayers();
    tipoColor.clear();

    const puntos = data.filter(d => Number.isFinite(d.LATITUD) && Number.isFinite(d.LONGITUD));
    if (!puntos.length) {
      resumenEl.innerHTML = "<em>No hay coordenadas disponibles.</em>";
      legendEl.style.display = "none";
      return;
    }

    const resumen = new Map();

    puntos.forEach(d => {
      const marker = L.marker([d.LATITUD, d.LONGITUD], { icon: iconoPara(d.TIPO) }).bindPopup(crearPopup(d));
      LAYER_CLUSTERS.addLayer(marker);
      const key = d.TIPO || "SIN DATO";
      resumen.set(key, (resumen.get(key) || 0) + 1);
    });

    const badges = Array.from(resumen.entries())
      .sort((a, b) => b[1] - a[1])
      .map(([tipo, cantidad]) => {
        const color = colorPara(tipo);
        return `<span style="background:${color}">${tipo}: ${cantidad}</span>`;
      });
    resumenEl.innerHTML = badges.join("");

    legendEl.innerHTML = Array.from(resumen.keys())
      .sort((a, b) => a.localeCompare(b, "es", { numeric: true }))
      .map(tipo => `<div><i style="background:${colorPara(tipo)}"></i>${tipo}</div>`)
      .join("");
    legendEl.style.display = "block";

    const bounds = L.latLngBounds(puntos.map(d => [d.LATITUD, d.LONGITUD]));
    MAP.fitBounds(bounds.pad(0.12));
  }

  async function fetchSupabase() {
    const url = new URL(`${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}`);
    url.searchParams.set("select", "*");
    url.searchParams.set("order", "fecha_reporte.desc");
    url.searchParams.set("limit", "2000");

    const response = await fetch(url, { headers: HEADERS });
    if (!response.ok) {
      const text = await response.text();
      throw new Error(`Supabase ${response.status} ${response.statusText}: ${text}`);
    }
    return response.json();
  }

  function parsearFila(row) {
    const fechaReporte = row.fecha_reporte ? new Date(row.fecha_reporte) : null;
    const lat = row.latitud === null ? null : Number(row.latitud);
    const lon = row.longitud === null ? null : Number(row.longitud);
    return {
      ID: row.radicado || row.id || "",
      FECHA_REPORTE_TXT: fechaReporte && !Number.isNaN(fechaReporte) ? fechaReporte.toISOString().slice(0, 10) : "",
      MUNICIPIO: row.municipio || "",
      TIPO: row.tipo || "SIN DATO",
      DESCRIPCION: row.descripcion || "",
      CANAL: row.canal || "SIN DATO",
      PUESTO: row.puesto_nombre || "",
      MESA: row.mesa_id || row.mesa_numero || "",
      REPORTANTE: [row.reportante_tipo, row.reportante_nombre].filter(Boolean).join(" - "),
      CONTACTO: row.reportante_telefono || row.origen_numero || "",
      EVIDENCIAS: Number(row.evidencias_count) || 0,
      LATITUD: Number.isFinite(lat) ? lat : NaN,
      LONGITUD: Number.isFinite(lon) ? lon : NaN
    };
  }

  async function cargarDatos() {
    if (btnRecargar) {
      btnRecargar.disabled = true;
      btnRecargar.textContent = "Cargando...";
    }
    if (lastUpdateEl) {
      lastUpdateEl.textContent = "Descargando datos...";
    }
    try {
      const rows = await fetchSupabase();
      const registros = rows.map(parsearFila);
      renderMap(registros);
      if (lastUpdateEl) {
        lastUpdateEl.textContent = "Ultima carga: " + new Date().toLocaleString();
      }
      if (totalReportesEl) {
        totalReportesEl.textContent = `${rows.length.toLocaleString("es-CO")} reportes`;
      }
    } catch (error) {
      console.error(error);
      if (lastUpdateEl) {
        lastUpdateEl.textContent = "Error al conectar con Supabase";
      }
      alert("No se pudieron cargar los datos de Supabase. Revisa la consola para mas detalles.");
    } finally {
      if (btnRecargar) {
        btnRecargar.disabled = false;
        btnRecargar.textContent = "Recargar datos";
      }
    }
  }

  initMap();
  cargarDatos();
  btnRecargar?.addEventListener("click", cargarDatos);
  </script>
</body>
</html>
